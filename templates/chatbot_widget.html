<!-- Premium Floating Career Coaching Chat Widget -->
<div id="chatbot-widget" class="chatbot-widget">
  <!-- Chatbot Toggle Button -->
  <button id="chatbot-toggle" class="chatbot-toggle" title="Career Coach">
    <svg
      class="chatbot-icon"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      stroke-width="2"
    >
      <path
        d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"
      ></path>
    </svg>
    <span class="chatbot-badge" id="chatbot-badge">1</span>
  </button>

  <!-- Chatbot Panel -->
  <div id="chatbot-panel" class="chatbot-panel">
    <!-- Header -->
    <div class="chatbot-header">
      <div class="chatbot-header-content">
        <h3>Career Coach</h3>
        <p class="chatbot-status">Ready to help</p>
      </div>
      <button id="chatbot-close" class="chatbot-close" title="Close">
        <svg
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
        >
          <line x1="18" y1="6" x2="6" y2="18"></line>
          <line x1="6" y1="6" x2="18" y2="18"></line>
        </svg>
      </button>
    </div>

    <!-- Messages Container -->
    <div id="chatbot-messages" class="chatbot-messages">
      <!-- Initial greeting will be loaded here -->
    </div>

    <!-- Suggestions -->
    <div id="chatbot-suggestions" class="chatbot-suggestions"></div>

    <!-- Input Area -->
    <div class="chatbot-input-area">
      <form id="chatbot-form" class="chatbot-form">
        <input
          type="text"
          id="chatbot-input"
          class="chatbot-input"
          placeholder="Ask about your career..."
          autocomplete="off"
        />
        <button type="submit" class="chatbot-send-btn" title="Send message">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path
              d="M16.6915026,12.4744748 L3.50612381,13.2599618 C3.19218622,13.2599618 3.03521743,13.4170592 3.03521743,13.5741566 L1.15159189,20.0151496 C0.8376543,20.8006365 0.99,21.89 1.77946707,22.52 C2.40,22.99 3.50612381,23.1 4.13399899,22.8429026 L21.714504,14.0454487 C22.6563168,13.5741566 23.1272231,12.6315722 22.6563168,11.6889879 L4.13399899,1.16346707 C3.34915502,0.9 2.40734225,0.9 1.77946707,1.37946707 C0.994623095,2.06496211 0.837654301,3.16346707 1.15159189,3.94914379 L3.03521743,10.4147418 C3.03521743,10.5741566 3.19218622,10.5741566 3.50612381,10.5741566 L16.6915026,11.3596435 C16.6915026,11.3596435 17.1624089,11.3596435 17.1624089,11.8429026 C17.1624089,12.3261617 16.6915026,12.4744748 16.6915026,12.4744748 Z"
            ></path>
          </svg>
        </button>
      </form>
    </div>

    <!-- Loading Indicator -->
    <div id="chatbot-loading" class="chatbot-loading" style="display: none">
      <div class="chatbot-typing-indicator">
        <span></span>
        <span></span>
        <span></span>
      </div>
    </div>
  </div>
</div>

<style>
  :root {
    --chatbot-primary: #1e40af;
    --chatbot-primary-dark: #1e3a8a;
    --chatbot-primary-light: #eff6ff;
    --chatbot-bg: #ffffff;
    --chatbot-text: #1a1a1a;
    --chatbot-text-secondary: #666;
    --chatbot-border: #e8e8e8;
    --chatbot-secondary-bg: #fafaf9;
    --chatbot-status-active: #059669;
  }

  body.dark-mode {
    --chatbot-bg: #1a1a1a;
    --chatbot-text: #f5f5f1;
    --chatbot-text-secondary: #999;
    --chatbot-border: #333;
    --chatbot-secondary-bg: #252525;
    --chatbot-primary-light: #1e3a8a;
  }

  /* Widget Container */
  #chatbot-widget {
    font-family:
      -apple-system, BlinkMacSystemFont, "Segoe UI", "Roboto", sans-serif;
    position: fixed;
    bottom: 24px;
    right: 24px;
    z-index: 9999;
    color: var(--chatbot-text);
  }

  /* Toggle Button */
  .chatbot-toggle {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: var(--chatbot-primary);
    color: white;
    border: none;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(30, 64, 175, 0.15);
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    position: relative;
  }

  .chatbot-toggle:hover {
    background: var(--chatbot-primary-dark);
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(30, 64, 175, 0.25);
  }

  .chatbot-toggle:active {
    transform: translateY(0);
  }

  .chatbot-icon {
    width: 24px;
    height: 24px;
    stroke-width: 2.5;
  }

  /* Badge */
  .chatbot-badge {
    position: absolute;
    top: -6px;
    right: -6px;
    background: #c53030;
    color: white;
    border-radius: 50%;
    width: 22px;
    height: 22px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    font-weight: 600;
    border: 2px solid white;
    box-shadow: 0 2px 6px rgba(197, 48, 48, 0.2);
  }

  .chatbot-badge.hidden {
    display: none;
  }

  /* Chat Panel */
  .chatbot-panel {
    position: absolute;
    bottom: 72px;
    right: 0;
    width: 400px;
    height: 580px;
    background: var(--chatbot-bg);
    border: 1px solid var(--chatbot-border);
    border-radius: 10px;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.08);
    display: flex;
    flex-direction: column;
    animation: slideUp 0.25s ease;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.25s ease,
      visibility 0.25s ease;
  }

  .chatbot-panel.active {
    opacity: 1;
    visibility: visible;
  }

  @keyframes slideUp {
    from {
      transform: translateY(16px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  /* Header */
  .chatbot-header {
    padding: 16px 20px;
    border-bottom: 1px solid var(--chatbot-border);
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: var(--chatbot-bg);
  }

  .chatbot-header-content h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
    color: var(--chatbot-text);
    letter-spacing: -0.3px;
  }

  .chatbot-status {
    margin: 4px 0 0 0;
    font-size: 12px;
    color: var(--chatbot-text-secondary);
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .chatbot-status::before {
    content: "";
    width: 6px;
    height: 6px;
    background: var(--chatbot-status-active);
    border-radius: 50%;
    display: inline-block;
  }

  .chatbot-close {
    background: transparent;
    border: none;
    color: var(--chatbot-text);
    cursor: pointer;
    padding: 6px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 6px;
    transition: all 0.2s ease;
  }

  .chatbot-close:hover {
    background: var(--chatbot-secondary-bg);
    color: var(--chatbot-text);
  }

  .chatbot-close svg {
    width: 18px;
    height: 18px;
    stroke-width: 2.5;
  }

  /* Messages Container */
  .chatbot-messages {
    flex: 1;
    overflow-y: auto;
    padding: 16px 20px;
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .chatbot-message {
    display: flex;
    gap: 8px;
    animation: fadeIn 0.2s ease;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(8px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .chatbot-message.user {
    justify-content: flex-end;
  }

  .chatbot-message.assistant {
    justify-content: flex-start;
  }

  .chatbot-message-content {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 13px;
    line-height: 1.5;
    word-wrap: break-word;
  }

  .chatbot-message.user .chatbot-message-content {
    background: var(--chatbot-primary);
    color: white;
    border-bottom-right-radius: 2px;
  }

  .chatbot-message.assistant .chatbot-message-content {
    background: var(--chatbot-secondary-bg);
    color: var(--chatbot-text);
    border: 1px solid var(--chatbot-border);
    border-bottom-left-radius: 2px;
  }

  .chatbot-timestamp {
    font-size: 11px;
    color: var(--chatbot-text-secondary);
    margin-top: 3px;
    opacity: 0.6;
  }

  /* Suggestions */
  .chatbot-suggestions {
    padding: 0 20px 12px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .chatbot-suggestion-btn {
    background: var(--chatbot-secondary-bg);
    border: 1px solid var(--chatbot-border);
    color: var(--chatbot-text);
    padding: 9px 12px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
    transition: all 0.2s ease;
    text-align: left;
    font-weight: 500;
    font-family: inherit;
  }

  .chatbot-suggestion-btn:hover {
    background: var(--chatbot-primary);
    color: white;
    border-color: var(--chatbot-primary);
    transform: translateX(2px);
  }

  /* Input Area */
  .chatbot-input-area {
    padding: 12px 20px;
    border-top: 1px solid var(--chatbot-border);
    background: var(--chatbot-bg);
  }

  .chatbot-form {
    display: flex;
    gap: 8px;
  }

  .chatbot-input {
    flex: 1;
    border: 1px solid var(--chatbot-border);
    border-radius: 6px;
    padding: 8px 12px;
    font-size: 13px;
    font-family: inherit;
    background: var(--chatbot-secondary-bg);
    color: var(--chatbot-text);
    transition: all 0.2s ease;
  }

  .chatbot-input:focus {
    outline: none;
    border-color: var(--chatbot-primary);
    background: var(--chatbot-bg);
    box-shadow: 0 0 0 2px rgba(30, 64, 175, 0.08);
  }

  .chatbot-input::placeholder {
    color: var(--chatbot-text-secondary);
  }

  .chatbot-send-btn {
    background: var(--chatbot-primary);
    border: none;
    border-radius: 6px;
    color: white;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
  }

  .chatbot-send-btn:hover {
    background: var(--chatbot-primary-dark);
    transform: translateY(-1px);
  }

  .chatbot-send-btn:active {
    transform: translateY(0);
  }

  .chatbot-send-btn svg {
    width: 16px;
    height: 16px;
  }

  .chatbot-send-btn:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    transform: none;
  }

  /* Loading Indicator */
  .chatbot-loading {
    display: flex;
    justify-content: center;
    padding: 12px;
  }

  .chatbot-typing-indicator {
    display: flex;
    gap: 4px;
    align-items: center;
  }

  .chatbot-typing-indicator span {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: var(--chatbot-primary);
    animation: typing 1.4s infinite;
  }

  .chatbot-typing-indicator span:nth-child(1) {
    animation-delay: 0s;
  }

  .chatbot-typing-indicator span:nth-child(2) {
    animation-delay: 0.2s;
  }

  .chatbot-typing-indicator span:nth-child(3) {
    animation-delay: 0.4s;
  }

  @keyframes typing {
    0%,
    60%,
    100% {
      transform: translateY(0);
      opacity: 0.6;
    }
    30% {
      transform: translateY(-8px);
      opacity: 1;
    }
  }

  /* Scrollbar Styling */
  .chatbot-messages::-webkit-scrollbar {
    width: 5px;
  }

  .chatbot-messages::-webkit-scrollbar-track {
    background: transparent;
  }

  .chatbot-messages::-webkit-scrollbar-thumb {
    background: var(--chatbot-border);
    border-radius: 3px;
  }

  .chatbot-messages::-webkit-scrollbar-thumb:hover {
    background: var(--chatbot-text-secondary);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    #chatbot-widget {
      bottom: 16px;
      right: 16px;
    }

    .chatbot-toggle {
      width: 52px;
      height: 52px;
    }

    .chatbot-panel {
      width: calc(100vw - 32px);
      height: calc(100vh - 100px);
      bottom: 64px;
      right: 16px;
      left: 16px;
      max-width: none;
    }

    .chatbot-message-content {
      max-width: 80%;
    }
  }

  @media (max-width: 480px) {
    .chatbot-panel {
      width: calc(100vw - 16px);
      height: calc(100vh - 80px);
      bottom: 56px;
      right: 8px;
      left: 8px;
    }

    .chatbot-toggle {
      width: 48px;
      height: 48px;
    }

    .chatbot-icon {
      width: 22px;
      height: 22px;
    }

    .chatbot-messages {
      padding: 12px 16px;
    }

    .chatbot-input-area {
      padding: 10px 16px;
    }

    .chatbot-input {
      font-size: 14px;
    }
  }
</style>

<script>
  // Premium Floating Career Coach Widget
  class ChatbotWidget {
    constructor() {
      this.isOpen = false;
      this.isLoading = false;
      this.userContext = null;
      this.messageCount = 0;
      this.init();
    }

    init() {
      // Get DOM elements
      this.toggle = document.getElementById("chatbot-toggle");
      this.panel = document.getElementById("chatbot-panel");
      this.closeBtn = document.getElementById("chatbot-close");
      this.form = document.getElementById("chatbot-form");
      this.input = document.getElementById("chatbot-input");
      this.sendBtn = document.querySelector(".chatbot-send-btn");
      this.messagesContainer = document.getElementById("chatbot-messages");
      this.suggestionsContainer = document.getElementById(
        "chatbot-suggestions",
      );
      this.loadingIndicator = document.getElementById("chatbot-loading");
      this.badge = document.getElementById("chatbot-badge");

      // Event listeners
      this.toggle.addEventListener("click", () => this.togglePanel());
      this.closeBtn.addEventListener("click", () => this.closePanel());
      this.form.addEventListener("submit", (e) => this.sendMessage(e));
      this.input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          this.sendMessage({ preventDefault: () => {} });
        }
      });

      // Load initial greeting
      this.loadGreeting();
    }

    togglePanel() {
      if (this.isOpen) {
        this.closePanel();
      } else {
        this.openPanel();
      }
    }

    openPanel() {
      this.isOpen = true;
      this.panel.classList.add("active");
      this.input.focus();
      this.badge.classList.add("hidden");
    }

    closePanel() {
      this.isOpen = false;
      this.panel.classList.remove("active");
    }

    async loadGreeting() {
      try {
        const response = await fetch("/api/chatbot/greeting");
        const data = await response.json();
        if (data.success) {
          this.addMessage("assistant", data.message);
          this.loadSuggestions();
        }
      } catch (error) {
        console.error("Error loading greeting:", error);
        this.addMessage(
          "assistant",
          "Hello! I'm here to help guide your career path. What would you like to explore today?",
        );
        this.loadSuggestions();
      }
    }

    async sendMessage(e) {
      e.preventDefault();

      const message = this.input.value.trim();
      if (!message) return;

      // Clear input
      this.input.value = "";
      this.input.focus();

      // Add user message
      this.addMessage("user", message);
      this.messageCount++;

      // Show loading
      this.showLoading();

      try {
        const context = this.extractContextFromPage();
        const response = await fetch("/api/chatbot/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            message: message,
            context: context,
          }),
        });

        const data = await response.json();

        if (data.success) {
          this.addMessage("assistant", data.message);
          if (data.suggestions) {
            this.showSuggestions(data.suggestions);
          }
        } else {
          this.addMessage(
            "assistant",
            "I'm having trouble responding right now. Let's try again.",
          );
        }
      } catch (error) {
        console.error("Error sending message:", error);
        this.addMessage(
          "assistant",
          "Sorry, I'm unable to respond at the moment. Please try again.",
        );
      } finally {
        this.hideLoading();
      }
    }

    addMessage(role, content) {
      const messageEl = document.createElement("div");
      messageEl.className = `chatbot-message ${role}`;

      const contentEl = document.createElement("div");
      contentEl.className = "chatbot-message-content";
      contentEl.textContent = content;

      messageEl.appendChild(contentEl);
      this.messagesContainer.appendChild(messageEl);

      // Auto-scroll to bottom
      setTimeout(() => {
        this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
      }, 0);
    }

    showLoading() {
      this.isLoading = true;
      this.loadingIndicator.style.display = "flex";
      this.sendBtn.disabled = true;
    }

    hideLoading() {
      this.isLoading = false;
      this.loadingIndicator.style.display = "none";
      this.sendBtn.disabled = false;
    }

    async loadSuggestions() {
      // Initial helpful suggestions
      const suggestions = [
        "What skills should I develop?",
        "What roles match my profile?",
        "How's my career readiness?",
        "What's my next step?",
      ];
      this.showSuggestions(suggestions);
    }

    showSuggestions(suggestions) {
      this.suggestionsContainer.innerHTML = "";
      suggestions.forEach((suggestion) => {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "chatbot-suggestion-btn";
        btn.textContent = suggestion;
        btn.onclick = () => {
          this.input.value = suggestion;
          this.sendMessage({ preventDefault: () => {} });
        };
        this.suggestionsContainer.appendChild(btn);
      });
    }

    extractContextFromPage() {
      // Extract user context from page (if available from form/session)
      return {
        name: document.querySelector("[data-user-name]")?.textContent || "User",
        interest:
          document.querySelector("[data-career-interest]")?.textContent || null,
        level:
          document.querySelector("[data-experience-level]")?.textContent ||
          null,
        known_skills:
          document.querySelector("[data-known-skills]")?.textContent || null,
        readiness_score:
          parseInt(
            document.querySelector("[data-readiness-score]")?.textContent,
          ) || null,
        confidence_score:
          parseInt(
            document.querySelector("[data-confidence-score]")?.textContent,
          ) || null,
      };
    }
  }

  // Initialize when DOM is ready
  document.addEventListener("DOMContentLoaded", () => {
    window.chatbotWidget = new ChatbotWidget();
  });
</script>
